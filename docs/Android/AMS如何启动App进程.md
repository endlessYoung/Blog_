# AMS如何启动App进程

Android 系统的 `Activity Manager Service（AMS）`是一个核心系统服务，负责管理应用程序的生命周期，其中包括启动和管理应用进程。下面是 AMS 如何启动应用进程的简要过程：

1. **应用启动请求**：

当用户或系统触发启动某个应用程序时，比如用户点击应用图标或收到系统广播等，这些请求会通过Binder接口传递给System Server中的AMS。AMS 将接收到启动应用的请求。

2. **应用启动前的准备**：

AMS 首先会检查系统中是否已经存在该应用的进程。如果该应用的进程已经存在并且处于空闲状态，则 AMS 可以选择重用该进程而不是启动一个新的进程。
如果应用的进程不存在，或者已经存在但不可用（比如被杀死），AMS会准备必要的参数，包括进程名称、UID、GID以及需要加载的类名等，启动新的应用进程。

3. **启动新进程**：

AMS 通过与 Zygote 进程进行通信，向其发送启动新应用进程的请求。
Zygote 进程收到请求后，会使用 `fork` 系统调用创建一个新的进程。新进程会继承 Zygote 进程的内存空间和已加载的类和库。

5. **新进程初始化**：

新进程启动后，会执行`ActivityThread.main()`方法，这是Android应用的主线程入口。这里会`初始化Application对象`，并准备执行具体的组件（如Activity）

6. **Binder连接**：

新进程内的`ActivityThread`会通过`Binder机制`与`AMS建立连接`，通过`attachApplication()`方法告诉AMS新进程已经准备好接收任务。

7. **应用进程启动**：

新进程会执行应用程序的入口点，通常是指定的 Activity。
在新进程中，Java 虚拟机（JVM）会加载并执行应用程序的 Java 代码，启动应用程序。
同时，系统会创建应用程序的主线程，执行应用程序的初始化操作，并显示用户界面。

8. **通知AMS应用启动成功**：

一旦新应用程序的进程启动成功，应用会向 **AMS** 发送启动完成的通知。
AMS 接收到通知后，会更新应用程序的状态，并根据需要执行后续操作，如显示应用界面。
总的来说，AMS 启动应用进程的过程涉及了与 Zygote 进程的通信、新进程的创建以及应用程序的初始化等步骤，以确保应用程序能够顺利启动并显示给用户。